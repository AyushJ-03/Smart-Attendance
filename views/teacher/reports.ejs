<%- include('../partials/header', { title: 'Reports' }) %>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Reports & Analytics</h1>
            <p class="text-gray-600 mt-2">Generate comprehensive attendance and performance reports</p>
        </div>
        <!-- <button onclick="generateAllReports()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
            <i class="fas fa-file-export mr-2"></i>
            Export All Reports
        </button> -->
    </div>

    <!-- Report Generation Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Daily Attendance Report -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Daily Report</h3>
                    <p class="text-sm text-gray-600">Today's attendance summary</p>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total Students:</span>
                    <span class="font-semibold" id="dailyTotal"><%= typeof reportData !== 'undefined' && reportData.daily ? reportData.daily.total : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Present:</span>
                    <span class="font-semibold text-green-600" id="dailyPresent"><%= typeof reportData !== 'undefined' && reportData.daily ? reportData.daily.present : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Absent:</span>
                    <span class="font-semibold text-red-600" id="dailyAbsent"><%= typeof reportData !== 'undefined' && reportData.daily ? reportData.daily.absent : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Attendance Rate:</span>
                    <span class="font-semibold text-blue-600" id="dailyRate"><%= typeof reportData !== 'undefined' && reportData.daily ? reportData.daily.rate + '%' : '-' %></span>
                </div>
            </div>
        </div>

        <!-- Monthly Attendance Report -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-calendar-alt text-purple-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Monthly Report</h3>
                    <p class="text-sm text-gray-600">Current month analysis</p>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">School Days:</span>
                    <span class="font-semibold" id="monthlyDays"><%= typeof reportData !== 'undefined' && reportData.monthly ? reportData.monthly.days : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Avg. Attendance:</span>
                    <span class="font-semibold text-purple-600" id="monthlyAvg"><%= typeof reportData !== 'undefined' && reportData.monthly ? reportData.monthly.avg + '%' : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Perfect Days:</span>
                    <span class="font-semibold text-green-600" id="monthlyPerfect"><%= typeof reportData !== 'undefined' && reportData.monthly ? reportData.monthly.perfect : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Low Days (<75%):</span>
                    <span class="font-semibold text-red-600" id="monthlyLow"><%= typeof reportData !== 'undefined' && reportData.monthly ? reportData.monthly.low : '-' %></span>
                </div>
            </div>
            <!-- <button onclick="generateMonthlyReport()" class="w-full mt-4 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                <i class="fas fa-download mr-2"></i>Generate Report
            </button> -->
        </div>

        <!-- Class Comparison Report -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-teal-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-chart-bar text-teal-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Class Comparison</h3>
                    <p class="text-sm text-gray-600">Compare class performance</p>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Best Class:</span>
                    <span class="font-semibold text-green-600" id="bestClass"><%= typeof reportData !== 'undefined' && reportData.classes ? reportData.classes.best : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Needs Attention:</span>
                    <span class="font-semibold text-red-600" id="needsAttention"><%= typeof reportData !== 'undefined' && reportData.classes ? reportData.classes.needsAttention : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Most Improved:</span>
                    <span class="font-semibold text-blue-600" id="mostImproved"><%= typeof reportData !== 'undefined' && reportData.classes ? reportData.classes.mostImproved : '-' %></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Avg. Difference:</span>
                    <span class="font-semibold" id="avgDifference"><%= typeof reportData !== 'undefined' && reportData.classes ? reportData.classes.avgDifference : '-' %></span>
                </div>
            </div>
            <!-- <button onclick="generateClassReport()" class="w-full mt-4 bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 transition-colors">
                <i class="fas fa-download mr-2"></i>Generate Report
            </button> -->
        </div>

        <!-- Custom Report -->
        <!-- <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover-scale">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-cogs text-indigo-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Custom Report</h3>
                    <p class="text-sm text-gray-600">Build your own report</p>
                </div>
            </div>
            <div class="space-y-3">
                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option>Select date range</option>
                    <option>Last 7 days</option>
                    <option>Last 30 days</option>
                    <option>Custom range</option>
                </select>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option>All classes</option>
                    <option>Class 1</option>
                    <option>Class 2</option>
                    <option>Class 3</option>
                </select>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <option>All metrics</option>
                    <option>Attendance only</option>
                    <option>Risk analysis</option>
                    <option>Trends</option>
                </select>
            </div>
            <button onclick="generateCustomReport()" class="w-full mt-4 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                <i class="fas fa-download mr-2"></i>Generate Report
            </button>
        </div> -->
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Attendance Trends Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                Attendance Trends (Last 30 Days)
            </h3>
            <div class="h-80">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <!-- Class Performance Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                Class Performance Comparison
            </h3>
            <div class="h-80">
                <canvas id="classChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-6">
            <i class="fas fa-analytics mr-2 text-purple-600"></i>
            Detailed Analytics
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-3xl font-bold text-blue-600 mb-2" id="totalStudentsAnalytics"><%= typeof reportData !== 'undefined' && reportData.analytics ? reportData.analytics.totalStudents : '-' %></div>
                <div class="text-sm text-gray-600">Total Students</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-3xl font-bold text-green-600 mb-2" id="avgAttendanceAnalytics"><%= typeof reportData !== 'undefined' && reportData.analytics ? reportData.analytics.avgAttendance + '%' : '-' %></div>
                <div class="text-sm text-gray-600">Average Attendance</div>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg">
                <div class="text-3xl font-bold text-red-600 mb-2" id="riskStudentsAnalytics"><%= typeof reportData !== 'undefined' && reportData.analytics ? reportData.analytics.riskStudents : '-' %></div>
                <div class="text-sm text-gray-600">At-Risk Students</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="text-3xl font-bold text-purple-600 mb-2" id="perfectAttendanceAnalytics"><%= typeof reportData !== 'undefined' && reportData.analytics ? reportData.analytics.perfectAttendance : '-' %></div>
                <div class="text-sm text-gray-600">Perfect Attendance</div>
            </div>
        </div>

        <!-- Top Performers and At-Risk Students -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                    Top Performers (>95% Attendance)
                </h4>
                <div id="topPerformersList" class="space-y-2">
                    <% if (reportData && reportData.topPerformers && reportData.topPerformers.length > 0) { %>
                        <% reportData.topPerformers.forEach(function(student) { %>
                            <div class="bg-yellow-50 border border-yellow-200 rounded px-3 py-2 flex justify-between items-center">
                                <span><%= student.name %> (<%= student.class %>)</span>
                                <span class="font-semibold text-green-700"><%= student.percentage %>%</span>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="text-gray-400 text-sm">No top performers in the last 30 days.</div>
                    <% } %>
                </div>
            </div>
            
            <div>
                <h4 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                    Students Needing Attention (<75% Attendance)
                </h4>
                <div id="atRiskList" class="space-y-2">
                    <% if (reportData && reportData.atRiskList && reportData.atRiskList.length > 0) { %>
                        <% reportData.atRiskList.forEach(function(student) { %>
                            <div class="bg-red-50 border border-red-200 rounded px-3 py-2 flex justify-between items-center">
                                <span><%= student.name %> (<%= student.class %>)</span>
                                <span class="font-semibold text-red-700"><%= student.percentage %>%</span>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="text-gray-400 text-sm">No students below 75% attendance in the last 30 days.</div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>


    // Report generation functions
    function generateDailyReport() {
        showGeneratingMessage('Generating daily attendance report...');
        setTimeout(() => {
            downloadReport('daily_attendance_report.pdf');
        }, 2000);
    }

    function generateWeeklyReport() {
        showGeneratingMessage('Generating weekly attendance report...');
        setTimeout(() => {
            downloadReport('weekly_attendance_report.pdf');
        }, 2000);
    }

    function generateMonthlyReport() {
        showGeneratingMessage('Generating monthly attendance report...');
        setTimeout(() => {
            downloadReport('monthly_attendance_report.pdf');
        }, 2000);
    }

    function generateStudentReport() {
        showGeneratingMessage('Generating student performance report...');
        setTimeout(() => {
            downloadReport('student_performance_report.pdf');
        }, 2000);
    }

    function generateClassReport() {
        showGeneratingMessage('Generating class comparison report...');
        setTimeout(() => {
            downloadReport('class_comparison_report.pdf');
        }, 2000);
    }

    function generateCustomReport() {
        showGeneratingMessage('Generating custom report...');
        setTimeout(() => {
            downloadReport('custom_attendance_report.pdf');
        }, 2000);
    }

    function generateAllReports() {
        showGeneratingMessage('Generating all reports... This may take a few minutes.');
        setTimeout(() => {
            downloadReport('all_attendance_reports.zip');
        }, 5000);
    }

    function showGeneratingMessage(message) {
        // Create and show a toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        toast.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-3"></div>
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function downloadReport(filename) {
        // Simulate file download
        const link = document.createElement('a');
        link.href = '#';
        link.download = filename;
        link.click();
        
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-3"></i>
                Report generated successfully!
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>

<%- include('../partials/footer') %>


<!-- Embed backend data for charts as JSON (only once) -->
<script id="trends-data" type="application/json"><%- JSON.stringify(reportData && reportData.trends ? reportData.trends : []) %></script>
<script id="class-perf-data" type="application/json"><%- JSON.stringify(reportData && reportData.classPerformance ? reportData.classPerformance : []) %></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Attendance Trends Chart
    let trendsData = [];
    try {
        trendsData = JSON.parse(document.getElementById('trends-data').textContent);
        console.log('Trends Data:', trendsData);
    } catch (e) {
        console.error('Failed to parse trends data:', e);
    }
    const trendsCanvas = document.getElementById('trendsChart');
    if (trendsCanvas && trendsData.length > 0 && window.Chart) {
        const trendsCtx = trendsCanvas.getContext('2d');
        new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: trendsData.map(d => d.date),
                datasets: [{
                    label: 'Attendance Rate (%)',
                    data: trendsData.map(d => d.rate),
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37,99,235,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Attendance (%)' }
                    },
                    x: {
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });
    } else {
        if (!window.Chart) console.error('Chart.js is not loaded!');
        if (!trendsCanvas) console.error('trendsChart canvas not found!');
        if (!trendsData.length) console.warn('No trends data to display.');
    }

    // Class Performance Chart
    let classPerfData = [];
    try {
        classPerfData = JSON.parse(document.getElementById('class-perf-data').textContent);
        console.log('Class Performance Data:', classPerfData);
    } catch (e) {
        console.error('Failed to parse class performance data:', e);
    }
    const classCanvas = document.getElementById('classChart');
    if (classCanvas && classPerfData.length > 0 && window.Chart) {
        const classCtx = classCanvas.getContext('2d');
        new Chart(classCtx, {
            type: 'bar',
            data: {
                labels: classPerfData.map(d => d.class),
                datasets: [{
                    label: 'Avg. Attendance (%)',
                    data: classPerfData.map(d => d.avgRate),
                    backgroundColor: '#22c55e',
                    borderColor: '#16a34a',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Attendance (%)' }
                    },
                    x: {
                        title: { display: true, text: 'Class' }
                    }
                }
            }
        });
    } else {
        if (!window.Chart) console.error('Chart.js is not loaded!');
        if (!classCanvas) console.error('classChart canvas not found!');
        if (!classPerfData.length) console.warn('No class performance data to display.');
    }
});
</script>